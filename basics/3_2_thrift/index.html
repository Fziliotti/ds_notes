<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Estudo de Caso - Thrift - Sistemas Distribuídos</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Estudo de Caso - Thrift";
    var mkdocs_page_input_path = "basics/3_2_thrift.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Sistemas Distribuídos</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Prólogo</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../intro/intro/">Introdução</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Sistemas Distribuídos</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>Estudo de Caso - Thrift</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="estudo-de-caso-rpc-thrift">Estudo de Caso RPC: Thrift</h1>
<p><a href="https://thrift.apache.org/">Thrift</a></p>
<h2 id="instalacao">Instalação</h2>
<ul>
<li><a href="http://www.apache.org/dyn/closer.cgi?path=/thrift/0.10.0/thrift-0.10.0.tar.gz">Baixe</a> e compile o thrift</li>
<li>ou instale-o usando apt-get, por exemplo. <code>apt-get install thrift-compiler</code></li>
<li>execute "thrift" na linha de comando.</li>
<li>Para thrift com Java, também precisarão dos seguintes arquivos</li>
<li><a href="http://mvnrepository.com/artifact/org.slf4j/slf4j-api/1.7.21">slf4j</a></li>
<li><a href="https://sites.google.com/site/lasaro/sistemasdistribuidos">libthrift0.9.3.jar</a></li>
<li>coloque-os na pasta <code>jars</code></li>
</ul>
<h2 id="idl-thrift">IDL Thrift</h2>
<ul>
<li>
<p>Tipos básicos</p>
<ul>
<li>bool: boolean (true/false)</li>
<li>byte: 8-bit; inteiro sinalizado</li>
<li>i16: 16-bit; inteiro sinalizado</li>
<li>i32: 32-bit; inteiro sinalizado</li>
<li>i64: 64-bit; inteiro sinalizado</li>
<li>double: 64-bit; ponto-flutuante </li>
<li>string: string UTF-8</li>
<li>binary: sequência de bytes</li>
</ul>
</li>
<li>
<p>Estruturas
 ```
struct Example {
    1:i32 number,
    2:i64 bigNumber,
    3:double decimals,
    4:string name="thrifty"
}</p>
</li>
</ul>
<pre><code>
* Serviços
</code></pre>

<p>service ChaveValor {
    void set(1:i32 key, 2:string value),
    string get(1:i32 key) throws (1:KeyNotFound knf),
    void delete(1:i32 key)
}</p>
<pre><code>* **Não se pode retornar NULL!!!**
* Exceções
</code></pre>

<p>exception KeyNotFound {
   1:i64 hora r,
   2:string chaveProcurada="thrifty"
}</p>
<pre><code>*  Containers
    * List
    * Map
    * Set


Exemplo: chavevalor.thrift

```Thrift
namespace java chavevalor
namespace py chavevalor


exception KeyNotFound
{
}


service ChaveValor
{
    string getKV(1:i32 key) throws (1:KeyNotFound knf),
    bool setKV(1:i32 key, 2:string value),
    void delKV(1:i32 key)
}  
</code></pre>

<p>Compilação</p>
<p><code>thrift --gen java chavevalor.thrift</code></p>
<p><code>thrift --gen py chavevalor.thrift</code></p>
<p>ChaveValorHandler.java</p>
<pre><code class="Java">namespace java chavevalor
namespace py chavevalor


exception KeyNotFound
{
}


service ChaveValor
{
    string getKV(1:i32 key) throws (1:KeyNotFound knf),
    bool setKV(1:i32 key, 2:string value),
    void delKV(1:i32 key)
}  

package chavevalor;

import org.apache.thrift.TException;
import java.util.HashMap;
import chavevalor.*;

public class ChaveValorHandler implements ChaveValor.Iface {
   private HashMap&lt;Integer,String&gt; kv = new HashMap&lt;&gt;();
   @Override
   public String getKV(int key) throws TException {
       if(kv.containsKey(key))
          return kv.get(key);
       else
          throw new KeyNotFound();
   }
   @Override
   public boolean setKV(int key, String valor) throws TException {
       kv.put(key,valor);
       return true;
   }
   @Override
   public void delKV(int key) throws TException {
       kv.remove(key);
   }    
}
</code></pre>

<h2 id="arquitetura">Arquitetura</h2>
<ul>
<li>Runtime library -- componentes podem ser selecionados em tempo de execução e implementações podem ser trocadas</li>
<li>Protocol -- responsável pela serializaçãoo dos dados<ul>
<li>TBinaryProtocol</li>
<li>TJSONProtocol</li>
<li>TDebugProtocol</li>
<li>...</li>
</ul>
</li>
<li>Transport -- I/O no ``fio''<ul>
<li>TSocket</li>
<li>TFramedTransport (non-blocking server)</li>
<li>TFileTransport</li>
<li>TMemoryTransport</li>
</ul>
</li>
<li>
<p>Processor -- Conecta protocolos de entrada e saída com o \emph{handler}</p>
</li>
<li>
<p>Handler -- Implementação das operações oferecidas</p>
</li>
<li>Server -- Escuta portas e repassa dados (protocolo) para o processors<ul>
<li>TSimpleServer</li>
<li>TThreadPool</li>
<li>TNonBlockingChannel</li>
</ul>
</li>
</ul>
<p>\subsubsection{Exemplo}
\begin{frame}[fragile,allowframebreaks]{ChaveValorServer.java}
    \lstinputlisting[language=Java]{../lab/thrift/ChaveValorServer.java}
\end{frame}</p>
<p>\begin{frame}[fragile,allowframebreaks]{ChaveValorClient.java}
    \lstinputlisting[language=Java]{../lab/thrift/ChaveValorClient.java}
\end{frame}</p>
<h2 id="classpath">Classpath</h2>
<pre><code class="bash">javac  -cp jars/libthrift0.9.3.jar:jars/slf4japi1.7.21.jar:gen-java  -d . *.java 

java -cp jars/libthrift0.9.3.jar:jars/slf4japi1.7.21.jar:gen-java:. chavevalor.ChaveValorServer

java -cp jars/libthrift0.9.3.jar:jars/slf4japi1.7.21.jar:gen-java:. chavevalor.ChaveValorClient 
</code></pre>

<h2 id="referencias">Referências</h2>
<p><a href="http://thrift-tutorial.readthedocs.org/en/latest/index.html">Tutorial</a></p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
