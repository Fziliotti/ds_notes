
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../../assets/images/favicon.png" rel="shortcut icon"/>
<meta content="mkdocs-1.1, mkdocs-material-5.1.1" name="generator"/>
<title>Tempo Lógico</title>
<link href="../../assets/stylesheets/main.a676eddb.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#relogio-logicos">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header-nav md-grid">
<a aria-label="Sistemas Distribuídos" class="md-header-nav__button md-logo" href="../.." title="Sistemas Distribuídos">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z"></path></svg>
</a>
<label class="md-header-nav__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z"></path></svg>
</label>
<div class="md-header-nav__title" data-md-component="header-title">
<div class="md-header-nav__ellipsis">
<span class="md-header-nav__topic md-ellipsis">
            Sistemas Distribuídos
          </span>
<span class="md-header-nav__topic md-ellipsis">
            
              Tempo Lógico
            
          </span>
</div>
</div>
<label class="md-header-nav__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Search" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path></svg>
</label>
<button aria-label="Clear" class="md-search__icon md-icon" data-md-component="search-reset" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"></path></svg>
</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Type to start searching
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Sistemas Distribuídos" class="md-nav__button md-logo" href="../.." title="Sistemas Distribuídos">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z"></path></svg>
</a>
    Sistemas Distribuídos
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../.." title="Prólogo">
      Prólogo
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../intro/" title="Introdução">
      Introdução
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../basics/" title="Fundamentos">
      Fundamentos
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../comm/" title="Comunicação">
      Comunicação
    </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path></svg>
</span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#relogios-logicos">
    Relógios Lógicos
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#happened-before">
    Happened-Before
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#lamport-clock">
    Lamport Clock
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#relogio-vetorial">
    Relógio vetorial
  </a>
<nav aria-label="Relógio vetorial" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#multicast-totalmente-ordenado">
    Multicast totalmente ordenado
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#multicast-causalmente-ordenado">
    Multicast causalmente ordenado
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#exclusao-mutua-revisitada">
    Exclusao Mútua Revisitada
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#relogios-hibridos">
    Relógios Híbridos
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hibrid-logical-clocks">
    Hibrid Logical Clocks
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#interceptadores">
    Interceptadores
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<h1 id="relogio-logicos">Relógio Lógicos</h1>
<p>Nas soluções anteriores, um nó precisa esperar por muito tempo antes de usar um recurso. 
E se ele aprendesse antes que os outros nós não farão requisições? 
Que não haverão sobreposições de requisições? 
E se houvesse um relógio que avançasse não com o tempo, mas com eventos interessantes do sistema?
Esta é a ideia dos <strong>relógios lógicos</strong>.</p>
<hr/>
<h6 id="relogios-logicos">Relógios Lógicos</h6>
<ul>
<li>Envio e recepção (e possivelmente outros eventos) fazem o relógio ``ticar''.</li>
<li>Processos podem usar este relógio para concordar na <strong>ordem</strong> dos eventos, mesmo que não no <strong>instante</strong> do evento.</li>
<li>Não há <strong>fonte da verdade</strong> em termos de tempo.</li>
<li>Cada processo mantém seu próprio relógio que pode ser relacionado com relógios de outros processos.</li>
</ul>
<p>Para chegarmos aos relógios lógicos, precisamos primeiro entender a relação <em>Happened-Before</em>, proposta por Leslie Lamport em <a href="http://amturing.acm.org/p558-lamport.pdf">Time, Clocks and the Ordering of Events in a Distributed System. July 5, 1978</a>, que lhe rendeu um <a href="https://www.microsoft.com/en-us/research/blog/leslie-lamport-receives-turing-award/">Prêmio Turing em 2014</a>.
Neste artigo, se estabelece o vocabulário para falar sobre ordem de eventos em um sistema computacional, em especial um distribuído.</p>
<hr/>
<h5 id="happened-before">Happened-Before</h5>
<ul>
<li>$a \rightarrow b$: evento $a$ aconteceu antes do evento $b$</li>
<li>Considerando um único processo (thread):</li>
<li>Se $a$ foi executado antes de $b$ no processo, então $a \rightarrow b$.</li>
<li>Considerando dois processos:</li>
<li>Se $a$ é o envio de uma mensagem e $b$ sua recepção, então $a \rightarrow b$.</li>
<li>Transitividade faz sentido:</li>
<li>Se $a \rightarrow b$ e $b \rightarrow c$, então $a \rightarrow c$</li>
</ul>
<hr/>
<p>Esta relação captura a <strong>causalidade</strong> entre eventos. Isto é, se $a \rightarrow b$ então $a$ potencialmente causou $b$ ($a$ precede $b$ em uma ordem causal).
Note que se $a \rightarrow b$ é falso e $b \rightarrow a$ é falso, então $a$ e $b$ são <strong>concorrentes</strong>.</p>
<p>Se capturarmos a causalidade de eventos, podemos usar esta informação para ordenar o se processamento, de forma a fazer sentido.
Considere o seguinte exemplo:</p>
<p>TODO: Exemplo e emails com pergunta e respostas.</p>
<p>Para que computadores possam usar a causalidade, precisamos capturar a relação de acontecer antes em um sistema.
Lamport propôs uma tal forma, que denominou relógio lógico, mas que hoje é conhecido universalmente como Relógios de Lamport.
Estes relógios permitem associar um <em>timestamp</em> a eventos de forma a se garantir a seguinte propriedade:
* seja $e$ um evento
* seja $C(e)$ o valor do relógio lógico quando associado a $e$
* se $a \rightarrow b$ então $C(a) &lt; C(b)$</p>
<p>Mas como definir a função $C$?
Experimentemos a seguinte definição:
* Seja $c_p$ um contador em $p$ com valor inicialmente igual a 0.
* $C(e) = c++$ no momento em que $e$ ocorreu.
* Usamos como $ &lt; $ a relação normal de inteiros.
Assim, cada processo conta os eventos executados localmente.
Veja um exemplo desta definição em ação.</p>
<p>!(LC - Primeira tentativa)(imagess/lc_cont.png)</p>
<p>É verdade neste cenário que se $a \rightarrow b$ então $C(a) &lt; C(b)$?<br/>
Observe com atenção os eventos $f$ e $k$. Para estes, a regra não é respeitada.
Para que seja, precisamos garantir que, na recepção de uma mensagem, os contadores sejam atualizados para que sejam maiores tanto que os relógios dos eventos locais quanto dos eventos que antecederam o envio da mensagem sendo recebida.
Com este ajuste, temos os Relógios de Lamport.</p>
<h2 id="lamport-clock">Lamport Clock</h2>
<ul>
<li>Seja $c_p$ um contador em $p$ com valor inicialmente igual a 0.</li>
<li>Se o evento $e$ é uma operação local, $C(e) = ++c$ no momento em que $e$ ocorreu.</li>
<li>Se o evento $e$ é o envio de uma mensagem, então $C(e)$ é enviado com a mensagem como seu timestamp.</li>
<li>Se o evento $e$ é a recepção de uma mensagem com timestamp $ts$, então $C(e) = max(c,ts)+1$.</li>
</ul>
<p>!(LC - Primeira tentativa)(imagess/lc_lamport.png)</p>
<p>Neste caso, temos que para quaisquer eventos $a,b$,  se $a \rightarrow b$ então $C(a) &lt; C(b)$.</p>
<p>TODO: Exemplo em que não é bom o suficiente.</p>
<p>Se $a \rightarrow b$ então $C(a) &lt; C(b)$. Contudo, a volta não é verdade, isto é, se $C(a) &lt; C(b)$ então $a \rightarrow b$.
Esta propriedade é interessante na ordenação de eventos, pois evita que eventos concorrentes sejam ordenados.
Entram os relógios vetoriais.</p>
<h2 id="relogio-vetorial">Relógio vetorial</h2>
<p>Sejam $n$ processos. No processo $p$
* Seja $c_p[i], 1 \leq i \leq n$ um contador, inicialmente igual a 0.
* Se o evento $e$ é uma operação local, $c_p[p]++$ e $C(e) = c_p$ no momento em que $e$ ocorreu.
* Se o evento $e$ é o envio de uma mensagem, então $C(e)$ é enviado com a mensagem como seu timestamp.
* Se o evento $e$ é a recepção de uma mensagem com timestamp $ts$ de $q$, então
  * $c_p[i] = max(c_p[i], ts[i]), i \neq p$
  * $c_p[p]++$
  * $C(e) = c_p$</p>
<p>!(Relógio Vetorial)[images/lc_vc.png]</p>
<p>Como dito, este relógio lógico tem a seguinte propriedade: se $a \rightarrow b \RightLeftArrow C(a) &lt; C(b)$.
Mas como é defido $ &lt; $ para vetores?
* $V = V' \iff V[i] = V'[i], 1 \leq i \leq n$
* $V \leq V' \iff V[i] \leq V'[i], 1 \leq i \leq n$</p>
<p>Sejam dois eventos $e$ e $e'$
* Se $e \rightarrow e' \iff V(e) &lt; V(e')$
* Se $V(e) \not\leq V(e')$ e $V(e') \not\leq V(e)$, são concorrentes.</p>
<p>Mas o que quer dizer $c_p[q] = k$?
Quer dizer que $p$ sabe que $q$ enviou $k$ mensagens.
E daí? O que pode ser feito com isso?<br/>
Com estes mecanismos é possível implementar
* Multicast Totalmente Ordenado:
  * Multicast: mensagens são enviadas de 1 para n (comunicação em grupo)
  * Totalmente Ordenado: todos os processos entregam as mensagens na mesma ordem
* Multicast Causalmente Ordenado:
  * Causalmente Ordenado: uma mensagem só é entregue se todas as que causalmente a precedem já foram entregues.</p>
<p>Novamente você pergunta, e daí? Bem, com estas abstrações, podemos resolver problemas interessantes como o seguinte.
Considere um programa qualquer, que se comporte de forma determinística (isto é, dada uma mesma entrada, gera sempre uma mesma saída). Como todo programa, este é uma máquina de estados, com a peculiaridade de ser determinística.
Logo, se tivermos várias cópias deste programa, executando em locais distintos, mas garantirmos que cada cópia verá exatamente a mesma entrada de dados, então garantiremos que todas as cópias transitarão pelos mesmos estados e chegarão ao mesmo estado final.
Acontece que multicast totalmente ordenado pode garantir exatamente isso, que todas as cópias receberão a mesma entrada.</p>
<p>!(State Machine Replication)[images/06-11.png]</p>
<p>Esta técnica é conhecida como Replicação de Maáquinas de Estados (em inglês, (<em>State Machine Replication</em>)[https://en.wikipedia.org/wiki/State_machine_replication]), ou pelo menos o seu princípio.</p>
<p>Mas como podemos implementar estas primitivas de multicast usando relógios lógicos?
Considere o seguinte algoritmo.</p>
<hr/>
<h6 id="multicast-totalmente-ordenado">Multicast totalmente ordenado</h6>
<ul>
<li>Fila com prioridade em cada processo.</li>
<li>Mensagens são enviadas a todos os processos e colocadas em uma fila local.</li>
<li>Mensagens recebidas são colocadas na fila local e ack é enviado de volta.</li>
<li>$p$ só entrega uma mensagem $m$ recebida de $q$, com timestamp $ts$ quando</li>
<li>$m$ está na cabeça da fila de $p$</li>
<li>Para cada processo $q$, há uma mensagem $m'$ de $q$, $ts'$, na fila de $p$ tal $ts &lt; ts'$</li>
<li>Canais confiáveis e FIFO.</li>
</ul>
<hr/>
<hr/>
<h6 id="multicast-causalmente-ordenado">Multicast causalmente ordenado</h6>
<ul>
<li>Mensagens são enviadas a todos os processos.</li>
<li>$p$ incrementa $c_p[p]$ somente no envio de mensagens.</li>
<li>$p$ só entrega uma mensagem recebida de $q$, com timestamp $ts$ quando</li>
<li>$ts[q] = c_p[q]+1$</li>
<li>$ts[k] \leq c_p[k], k \neq q$</li>
</ul>
<p>\includegraphics[width=.5\textwidth]{images/06-13}</p>
<p>Considere $c_{P_2}[0,2,2]$ e $ts=[1,3,0]$, de $P_0$. O que $P_2$ está esperando? Como age ao receber mensagem com $ts$?</p>
<hr/>
<h2 id="exclusao-mutua-revisitada">Exclusao Mútua Revisitada</h2>
<p>Retorno à exclusão mútua</p>
<p>TODO: (Algoritmos de Excluão mútua baeados em LC)[http://www.cs.cmu.edu/~dga/15-440/F10/lectures/Distributed-Mutual-Exclusion-slides.pdf]</p>
<p>TODO: Algoritmo de Lamport, Ricart e agrawalla</p>
<p>TODO: Algoritmo de (Maekawa)[https://www.coursera.org/learn/cloud-computing-2/lecture/GMHYN/2-4-maekawas-algorithm-and-wrap-up]</p>
<h2 id="relogios-hibridos">Relógios Híbridos</h2>
<p>TODO: (Google TrueTime)[https://cloud.google.com/spanner/docs/true-time-external-consistency)</p>
<h2 id="hibrid-logical-clocks">Hibrid Logical Clocks</h2>
<p>!(Hibrid Logical Clock)[images/lc_hybrid]</p>
<p>Onde se lê 3,13, leia-se 3,10,3.</p>
<p>(Fonte)(http://muratbuffalo.blogspot.com.br/2014/07/hybrid-logical-clocks.html)</p>
<h2 id="interceptadores">Interceptadores</h2>
<p>!(Transparente para a aplicação)[images/06-10]</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs
        </a>
</div>
</div>
</div>
</footer>
</div>
<script src="../../assets/javascripts/vendor.c51dfa35.min.js"></script>
<script src="../../assets/javascripts/bundle.eaaa3931.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
<script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.58d22e8e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
<script src="https://unpkg.com/mermaid@8.5.0/dist/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="../../mathjaxhelper.js"></script>
</body>
</html>